"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function mydef(x,y){return"function"!=typeof define?require("amdefine")(module)(x,y):define(x,y)}mydef(["web-fc-solve--expand-moves","big-integer"],function(expand,bigInt){var fc_solve_expand_move=expand.fc_solve_expand_move,fc_solve__hll_ms_rand__get_singleton=null,fc_solve__hll_ms_rand__init=null,fc_solve__hll_ms_rand__mod_rand=null,fc_solve_user__find_deal__alloc=null,fc_solve_user__find_deal__fill=null,fc_solve_user__find_deal__free=null,fc_solve_user__find_deal__run=null,freecell_solver_user_alloc=null,freecell_solver_user_solve_board=null,freecell_solver_user_resume_solution=null,freecell_solver_user_cmd_line_read_cmd_line_preset=null,malloc=null,c_free=null,freecell_solver_user_get_next_move=null,freecell_solver_user_get_num_freecells=null,freecell_solver_user_get_num_stacks=null,freecell_solver_user_current_state_stringify=null,freecell_solver_user_stringify_move_ptr=null,freecell_solver_user_free=null,freecell_solver_user_limit_iterations_long=null,freecell_solver_user_get_invalid_state_error_into_string=null,freecell_solver_user_cmd_line_parse_args_with_file_nesting_count=null,fc_solve_Pointer_stringify=null,fc_solve_FS_writeFile=null,fc_solve_getValue=null,fc_solve_setValue=null,fc_solve_intArrayFromString=null,fc_solve_allocate_i8=null;function alloc_wrap(size,desc,error){var ret=malloc(size);if(0==ret)throw alert("Could not allocate "+desc+" (out of memory?)"),error;return ret}var remove_trailing_space_re=/[ \t]+$/gm,fc_solve_2uni_suit_map={H:"♥",C:"♣",D:"♦",S:"♠"};function fc_solve_2uni_card(match,p1,p2,offset,mystring){return p1+fc_solve_2uni_suit_map[p2]}function fc_solve_2uni_found(match,p1,p2,offset,mystring){return fc_solve_2uni_suit_map[p1]+p2}var FC_Solve=function(){function FC_Solve(args){_classCallCheck(this,FC_Solve);var that=this;that.dir_base=args.dir_base,that.string_params=args.string_params,that.set_status_callback=args.set_status_callback,that.is_unicode_cards=args.is_unicode_cards||!1,that.cmd_line_preset=args.cmd_line_preset,that.current_iters_limit=0,that.obj=function(){var ret_obj=freecell_solver_user_alloc();if(0==ret_obj)throw alert("Could not allocate solver instance (out of memory?)"),"Foo";if(0!=that._initialize_obj(ret_obj))throw alert("Failed to initialize solver (Bug!)"),freecell_solver_user_free(ret_obj),"Bar";return ret_obj}(),that._proto_states_and_moves_seq=null,that._pre_expand_states_and_moves_seq=null,that._post_expand_states_and_moves_seq=null,that._state_string_buffer=alloc_wrap(500,"state string buffer","Zam"),that._move_string_buffer=alloc_wrap(200,"move string buffer","Plum")}return _createClass(FC_Solve,[{key:"set_status",value:function(myclass,mylabel){return this.set_status_callback(myclass,mylabel)}},{key:"handle_err_code",value:function(solve_err_code){if(8==solve_err_code){var error_string_ptr=alloc_wrap(300,"state error string","Gum");freecell_solver_user_get_invalid_state_error_into_string(this.obj,error_string_ptr,1);var error_string=fc_solve_Pointer_stringify(error_string_ptr);throw c_free(error_string_ptr),alert(error_string+"\n"),"Foo"}if(5==solve_err_code)return this.current_iters_limit>=131072?void this.set_status("exceeded","Iterations count exceeded at "+this.current_iters_limit):void this.set_status("running","Running ("+this.current_iters_limit+" iterations)");if(0!=solve_err_code){if(1!=solve_err_code)throw alert("Unknown Error code "+solve_err_code+"!"),"Foo";this.set_status("impossible","Could not solve.")}else this.set_status("solved","Solved")}},{key:"_increase_iters_limit",value:function(){this.current_iters_limit+=1e3,freecell_solver_user_limit_iterations_long(this.obj,this.current_iters_limit)}},{key:"resume_solution",value:function(){this._increase_iters_limit();var solve_err_code=freecell_solver_user_resume_solution(this.obj);return this.handle_err_code(solve_err_code),solve_err_code}},{key:"_process_board_string",value:function(proto_board_string){return proto_board_string.match(/\n$/)?proto_board_string+"":proto_board_string+"\n"}},{key:"_stringify_possibly_null_ptr",value:function(s_ptr){return s_ptr?fc_solve_Pointer_stringify(s_ptr):""}},{key:"_initialize_obj",value:function(obj){var cmd_line_preset=this.cmd_line_preset;try{if("default"!=cmd_line_preset){var error_string_ptr_buf=alloc_wrap(128,"error string buffer","Foo"),preset_ret=freecell_solver_user_cmd_line_read_cmd_line_preset(obj,cmd_line_preset,0,error_string_ptr_buf,0,null),error_string_ptr=fc_solve_getValue(error_string_ptr_buf,"*"),error_string=this._stringify_possibly_null_ptr(error_string_ptr);if(c_free(error_string_ptr),c_free(error_string_ptr_buf),0!=preset_ret)throw alert("Failed to load command line preset '"+cmd_line_preset+"'. Problem is: «"+error_string+"». Should not happen."),"Foo"}if(this.string_params){var _error_string_ptr_buf=alloc_wrap(128,"error string buffer","Engo");fc_solve_FS_writeFile("/string-params.fc-solve.txt",this.string_params,{});var args_buf=alloc_wrap(8,"args buf","Seed"),read_from_file_str_ptr=fc_solve_allocate_i8(fc_solve_intArrayFromString("--read-from-file")),arg_str_ptr=fc_solve_allocate_i8(fc_solve_intArrayFromString("0,/string-params.fc-solve.txt"));fc_solve_setValue(args_buf,read_from_file_str_ptr,"*"),fc_solve_setValue(args_buf+4,arg_str_ptr,"*");var last_arg_ptr=alloc_wrap(4,"last_arg_ptr","cherry"),args_ret_code=freecell_solver_user_cmd_line_parse_args_with_file_nesting_count(obj,2,args_buf,0,0,0,0,_error_string_ptr_buf,last_arg_ptr,-1,0);c_free(last_arg_ptr),c_free(args_buf);var _error_string_ptr=fc_solve_getValue(_error_string_ptr_buf,"*"),_error_string=this._stringify_possibly_null_ptr(_error_string_ptr);if(c_free(_error_string_ptr),c_free(_error_string_ptr_buf),0!=args_ret_code)throw alert("Failed to process user-specified command line arguments. Problem is: «"+_error_string+"»."),"Foo"}return 0}catch(e){return this.set_status("error","Error"),-1}}},{key:"do_solve",value:function(proto_board_string){this.set_status("running","Running");try{this._increase_iters_limit();var board_string=this._process_board_string(proto_board_string),solve_err_code=freecell_solver_user_solve_board(this.obj,board_string);return this.handle_err_code(solve_err_code),solve_err_code}catch(e){return void this.set_status("error","Error")}}},{key:"_replace_card",value:function(s){return s.replace(/\b([A2-9TJQK])([HCDS])\b/g,fc_solve_2uni_card)}},{key:"_replace_found",value:function(s){return s.replace(/\b([HCDS])(-[0A2-9TJQK])\b/g,fc_solve_2uni_found)}},{key:"unicode_preprocess",value:function(out_buffer){return this.is_unicode_cards?this._replace_found(this._replace_card(out_buffer)):out_buffer}},{key:"_calc_states_and_moves_seq",value:function(){var that=this;if(!that._pre_expand_states_and_moves_seq){var states_and_moves_sequence=[];_out_state(get_state_str());for(var move_buffer=alloc_wrap(128,"a buffer for the move","maven");0==freecell_solver_user_get_next_move(that.obj,move_buffer);){var state_as_string=get_state_str();freecell_solver_user_stringify_move_ptr(that.obj,that._move_string_buffer,move_buffer,0);var move_as_string=fc_solve_Pointer_stringify(that._move_string_buffer);states_and_moves_sequence.push({type:"m",m:{type:"m",str:move_as_string},exp:null,is_exp:!1}),_out_state(state_as_string)}that._proto_states_and_moves_seq=states_and_moves_sequence,that._pre_expand_states_and_moves_seq=states_and_moves_sequence.map(function(item){return"m"==item.type?item.m:item}),that._post_expand_states_and_moves_seq=null,c_free(move_buffer),freecell_solver_user_free(that.obj),that.obj=0,c_free(that._state_string_buffer),that._state_string_buffer=0,c_free(that._move_string_buffer),that._move_string_buffer=0}function _out_state(s){states_and_moves_sequence.push({type:"s",str:s})}function get_state_str(){return freecell_solver_user_current_state_stringify(that.obj,that._state_string_buffer,1,0,1),fc_solve_Pointer_stringify(that._state_string_buffer)}}},{key:"_calc_expanded_move",value:function(idx){var states_and_moves_sequence=this._proto_states_and_moves_seq;return states_and_moves_sequence[idx].exp||(states_and_moves_sequence[idx].exp=fc_solve_expand_move(8,4,states_and_moves_sequence[idx-1].str,states_and_moves_sequence[idx].m,states_and_moves_sequence[idx+1].str)),states_and_moves_sequence[idx].exp}},{key:"_calc_expanded_seq",value:function(){if(!this._post_expand_states_and_moves_seq){this._calc_states_and_moves_seq();for(var states_and_moves_sequence=this._proto_states_and_moves_seq,new_array=[states_and_moves_sequence[0]],i=1;i<states_and_moves_sequence.length-1;i+=2)Array.prototype.push.apply(new_array,this._calc_expanded_move(i)),new_array.push(states_and_moves_sequence[i+1]);this._post_expand_states_and_moves_seq=new_array}}},{key:"_display_specific_sol",value:function(seq){var out_buffer="";function my_append(str){out_buffer+=str}return my_append("-=-=-=-=-=-=-=-=-=-=-=-\n\n"),seq.forEach(function(x){var t_=x.type;my_append(x.str+("s"==t_?"\n\n====================\n\n":"\n\n"))}),this.unicode_preprocess(out_buffer.replace(remove_trailing_space_re,""))}},{key:"display_solution",value:function(args){var ret=void 0;try{this._calc_states_and_moves_seq(),this.set_status("solved","Solved"),ret=this._display_specific_sol(this._pre_expand_states_and_moves_seq)}catch(e){return}return ret}},{key:"display_expanded_moves_solution",value:function(args){return this._calc_expanded_seq(),this.set_status("solved","Solved"),this._display_specific_sol(this._post_expand_states_and_moves_seq)}},{key:"generic_display_sol",value:function(args){return args.expand?this.display_expanded_moves_solution(args):this.display_solution(args)}},{key:"get_num_freecells",value:function(){return freecell_solver_user_get_num_freecells(this.obj)}},{key:"get_num_stacks",value:function(){return freecell_solver_user_get_num_stacks(this.obj)}}]),FC_Solve}(),MSRand=function(){function MSRand(args){_classCallCheck(this,MSRand);this.gamenumber=args.gamenumber,this.rander=fc_solve__hll_ms_rand__get_singleton(),fc_solve__hll_ms_rand__init(this.rander,""+this.gamenumber)}return _createClass(MSRand,[{key:"max_rand",value:function(mymax){return fc_solve__hll_ms_rand__mod_rand(this.rander,mymax)}},{key:"shuffle",value:function(deck){if(deck.length)for(var i=deck.length;--i;){var j=this.max_rand(i+1),tmp=deck[i];deck[i]=deck[j],deck[j]=tmp}return deck}}]),MSRand}();return{FC_Solve:FC_Solve,FC_Solve_init_wrappers_with_module:function(Module){fc_solve__hll_ms_rand__get_singleton=Module.cwrap("fc_solve__hll_ms_rand__get_singleton","number",[]),fc_solve__hll_ms_rand__init=Module.cwrap("fc_solve__hll_ms_rand__init","number",["number","string"]),fc_solve__hll_ms_rand__mod_rand=Module.cwrap("fc_solve__hll_ms_rand__mod_rand","number",["number","number"]),fc_solve_user__find_deal__alloc=Module.cwrap("fc_solve_user__find_deal__alloc","number",[]),fc_solve_user__find_deal__fill=Module.cwrap("fc_solve_user__find_deal__fill","number",["number","string"]),fc_solve_user__find_deal__free=Module.cwrap("fc_solve_user__find_deal__free","number",["number"]),fc_solve_user__find_deal__run=Module.cwrap("fc_solve_user__find_deal__run","string",["number","string","string"]),freecell_solver_user_alloc=Module.cwrap("freecell_solver_user_alloc","number",[]),freecell_solver_user_solve_board=Module.cwrap("freecell_solver_user_solve_board","number",["number","string"]),freecell_solver_user_resume_solution=Module.cwrap("freecell_solver_user_resume_solution","number",["number"]),freecell_solver_user_cmd_line_read_cmd_line_preset=Module.cwrap("freecell_solver_user_cmd_line_read_cmd_line_preset","number",["number","string","number","number","number","string"]),malloc=Module.cwrap("malloc","number",["number"]),c_free=Module.cwrap("free","number",["number"]),freecell_solver_user_get_next_move=Module.cwrap("freecell_solver_user_get_next_move","number",["number","number"]),freecell_solver_user_get_num_freecells=Module.cwrap("freecell_solver_user_get_num_freecells","number",["number"]),freecell_solver_user_get_num_stacks=Module.cwrap("freecell_solver_user_get_num_stacks","number",["number"]),freecell_solver_user_current_state_stringify=Module.cwrap("freecell_solver_user_current_state_stringify","number",["number","number","number","number","number"]),freecell_solver_user_stringify_move_ptr=Module.cwrap("freecell_solver_user_stringify_move_ptr","number",["number","number","number","number"]),freecell_solver_user_free=Module.cwrap("freecell_solver_user_free","number",["number"]),freecell_solver_user_limit_iterations_long=Module.cwrap("freecell_solver_user_limit_iterations_long","number",["number","number"]),freecell_solver_user_get_invalid_state_error_into_string=Module.cwrap("freecell_solver_user_get_invalid_state_error_into_string","number",["number","number","number"]),freecell_solver_user_cmd_line_parse_args_with_file_nesting_count=Module.cwrap("freecell_solver_user_cmd_line_parse_args_with_file_nesting_count","number",["number","number","number","number","number","number","number","number","number","number","number"]),fc_solve_Pointer_stringify=function(ptr){return Module.Pointer_stringify(ptr)},fc_solve_FS_writeFile=function(p1,p2,p3){return Module.FS.writeFile(p1,p2,p3)},fc_solve_getValue=function(p1,p2){return Module.getValue(p1,p2)},fc_solve_setValue=function(p1,p2,p3){return Module.setValue(p1,p2,p3)},fc_solve_intArrayFromString=function(s){return Module.intArrayFromString(s)},fc_solve_allocate_i8=function(p1){return Module.allocate(p1,"i8",Module.ALLOC_STACK)}},FCS_STATE_SUSPEND_PROCESS:5,FCS_STATE_WAS_SOLVED:0,Freecell_Deal_Finder:function(){function Freecell_Deal_Finder(args){_classCallCheck(this,Freecell_Deal_Finder);this.obj=fc_solve_user__find_deal__alloc()}return _createClass(Freecell_Deal_Finder,[{key:"fill",value:function(str){fc_solve_user__find_deal__fill(this.obj,str)}},{key:"release",value:function(){fc_solve_user__find_deal__free(this.obj)}},{key:"run",value:function(abs_start,abs_end_param,update_cb){var CHUNK=bigInt(1e6);this.CHUNKM=CHUNK.add(bigInt.minusOne);var start=bigInt(abs_start),abs_end=bigInt(abs_end_param);this.abs_end=abs_end,this.start=start,this.update_cb=update_cb}},{key:"cont",value:function(){var abs_end=this.abs_end;if(this.start.lesser(abs_end)){this.update_cb({start:this.start});var end=this.start.add(this.CHUNKM);end.gt(abs_end)&&(end=abs_end);var result=fc_solve_user__find_deal__run(this.obj,this.start.toString(),end.toString());return"-1"!=result?{found:!0,result:result}:(this.start=end.add(bigInt.one),{found:!1,cont:!0})}return{found:!1,cont:!1}}}]),Freecell_Deal_Finder}(),deal_ms_fc_board:function(seed){var randomizer=new MSRand({gamenumber:seed});function _perl_range(start,end){for(var ret=[],i=start;i<=end;i++)ret.push(i);return ret}var columns=_perl_range(0,7).map(function(){return[]}),deck=_perl_range(0,51);randomizer.shuffle(deck),deck=deck.reverse();for(var i=0;i<52;i++)columns[i%8].push(deck[i]);function render_card(card){var suit=card%4,rank=Math.floor(card/4);return"A23456789TJQK".charAt(rank)+"CDHS".charAt(suit)}return columns.map(function(col){return": "+col.map(render_card).join(" ")+"\n"}).join("")}}});